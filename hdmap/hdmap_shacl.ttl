@prefix hdmap: <https://ontologies.envited-x.net/hdmap/v5/ontology#> .
@prefix envited-x: <https://ontologies.envited-x.net/envited-x/v3/ontology#> .
@prefix manifest: <https://ontologies.envited-x.net/manifest/v5/ontology#> .
@prefix georeference: <https://ontologies.envited-x.net/georeference/v5/ontology#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix openlabel: <https://openlabel.asam.net/V1-0-0/ontologies/> .

hdmap:HdMapShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass hdmap:HdMap ;

    # 1) hasDataResource
    sh:property [
        sh:path hdmap:hasDataResource ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:or (
            [ sh:node envited-x:DataResourceShape ]
            [ sh:and ( manifest:LinkShape envited-x:ExtendedLinkShape ) ]
        ) ;
        sh:message "Each HD map must have exactly one associated DataResource (either inline conforming to envited-x:DataResourceShape or a valid manifest:Link)."@en ;
    ] ;

    # 2) hasDataResourceExtension
    sh:property [
        sh:path hdmap:hasDataResourceExtension ;
        sh:node hdmap:DataResourceExtensionShape ; 
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Each HD map must have one associated DataResourceExtension object with format, content, quantity, quality, dataSource, and georeference."@en ;
    ] ;

    # 3) hasManifest
    sh:property [
        sh:path hdmap:hasManifest ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:or (
            # Case 1: Inline manifest node (Validates against standard Manifest rules)
            [ sh:and ( manifest:ManifestShape envited-x:ManifestShape ) ]

            # Case 2: Linked manifest reference (Validates the link itself)
            [ sh:node envited-x:ManifestLinkReferenceShape ]
        ) ;
        sh:message "Each HD map must have exactly one manifest. If linked, it must be a valid envited-x link specifically of category envited-x:isManifest and include a manifest:iri."@en ;
    ] .


hdmap:DataResourceExtensionShape a sh:NodeShape ;
    sh:closed false ;
    
    sh:property
        [
            sh:maxCount 1 ;
            sh:minCount 1 ;
            sh:node hdmap:FormatShape ;
            sh:name "format object"@en ;
            sh:description "Contains properties to describe the format of the HD map asset."@en ;
            sh:order 1 ;
            sh:path hdmap:hasFormat
        ],
        [
            sh:maxCount 1 ;
            sh:minCount 1 ;
            sh:node hdmap:ContentOrOddSceneryShape ; # Refactored to use the Union Shape
            sh:message "Each item of hasContent must conform to either Scenario Content or OpenLABEL ODD Scenery."@en ;
            sh:name "content object"@en ;
            sh:description "Defines the content of the HD map asset."@en ;
            sh:order 2 ;
            sh:path hdmap:hasContent ;
        ],
        [
            sh:maxCount 1 ;
            sh:minCount 1 ;
            sh:node hdmap:QuantityShape ;
            sh:name "quantity object"@en ;
            sh:description "Contains properties to describe the quantity of the HD map asset."@en ;
            sh:order 3 ;
            sh:path hdmap:hasQuantity
        ],
        [
            sh:maxCount 1 ;
            sh:minCount 1 ;
            sh:node hdmap:QualityShape ;
            sh:name "quality object"@en ;
            sh:description "Contains properties to describe the accuracy of the HD map asset."@en ;
            sh:order 4 ;
            sh:path hdmap:hasQuality
        ],
        [
            sh:maxCount 1 ;
            sh:minCount 1 ;
            sh:node hdmap:DataSourceShape ;
            sh:name "dataSource object"@en ;
            sh:description "Defines which data resources or measurement systems were used to create the HD map asset."@en ;
            sh:order 5 ;
            sh:path hdmap:hasDataSource
        ],
        [
            sh:maxCount 1 ;
            sh:minCount 1 ;
            sh:node georeference:GeoreferenceShape ;
            sh:name "has georeference"@en ; 
            sh:message "Each HD map must link to a georeference dataset defining the location/projection of the HD map asset."@en ;
            sh:order 6 ;
            sh:path hdmap:hasGeoreference ;
        ] ;
    sh:targetClass hdmap:DataResourceExtension .

hdmap:ContentOrOddSceneryShape a sh:NodeShape ;
    sh:description "HDMap Content or OpenLABEL ODD Scenery Union Shape"@en ;
    sh:or (
        [ sh:node hdmap:ContentShape ]
        [ sh:node openlabel:OddShape ] # Validates against the external OpenLABEL shape
        [ sh:node xsd:boolean ]
    ) ;
    sh:message "Each item of hasContent must conform to either Scenario Content or OpenLABEL Tag."@en .

hdmap:ContentShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass hdmap:Content ;
    
    sh:property [ skos:example "[motorway, rural]" ;
            sh:description "Lists the road types used in the HD map asset."@en ;
            sh:in ("bicycle" "lowSpeed" "motorway" "pedestrian" "rural" "townArterial" "townCollector" "townExpressway" "townLocal" "townPlayStreet" "townPrivate" "town" "unknown") ;
            sh:message "Validation of roadTypes failed!"@en ;
            sh:name "road types"@en ;
            sh:order 0 ;
            sh:path hdmap:roadTypes ],
        [ skos:example "shoulder, curb, ..." ;
            sh:description "Lists the lanes types used in the HD map asset."@en ;
            sh:in ("biking" "border" "connectingRamp" "curb" "driving" "entry" "exit" "median" "none" "offRamp" "onRamp" "parking" "restricted" "shoulder" "slipLane" "stop" "walking") ;
            sh:message "Validation of laneTypes failed!"@en ;
            sh:name "lane types"@en ;
            sh:order 1 ;
            sh:path hdmap:laneTypes ],
        [ skos:example "trees, street lamps, road patches, ..." ;
            sh:description "Lists the object types used in the HD map asset."@en ;
            sh:in ("barrier" "bike" "building" "bus" "car" "crosswalk" "gantry" "motorbike") ;
            sh:message "Validation of levelOfDetail failed!"@en ;
            sh:name "level of detail"@en ;
            sh:order 2 ;
            sh:path hdmap:levelOfDetail ],
        [ skos:example "right-hand traffic" ;
            sh:description "Indicates whether the HD map is designed for left or right-hand traffic."@en ;
            sh:in ("left-hand" "right-hand") ;
            sh:maxCount 1 ;
            sh:message "Validation of trafficDirection failed!"@en ;
            sh:name "traffic direction"@en ;
            sh:order 3 ;
            sh:path hdmap:trafficDirection ] .

hdmap:DataSourceShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass hdmap:DataSource ;
    
    sh:property [ skos:example "3DMS system, Trimble xyz, Riegl xyz" ;
            sh:datatype xsd:string ;
            sh:description "Specifies the name of the primary acquisition device."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of measurementSystem failed!"@en ;
            sh:name "measurement system"@en ;
            sh:order 1 ;
            sh:path hdmap:measurementSystem ],
        [ skos:example "scanner, camera, osm network, aerial images, ..." ;
            sh:datatype xsd:string ;
            sh:description "Indicates the source data used to create the HD map."@en ;
            sh:message "Validation of usedDataSources failed!"@en ;
            sh:name "used data sources"@en ;
            sh:order 0 ;
            sh:path hdmap:usedDataSources ] .

hdmap:FormatShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass hdmap:Format ;
    
    sh:property [ skos:example "1.8.1" ;
            sh:datatype xsd:string ;
            sh:description "Defines the version of the data format used for the HD map asset."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of version failed!"@en ;
            sh:name "version"@en ;
            sh:order 1 ;
            sh:path hdmap:version ],
        [ skos:example "ASAM OpenDRIVE" ;
            sh:datatype xsd:string ;
            sh:description "Defines the type of data format used for the HD map asset."@en ;
            sh:in ("ASAM OpenDRIVE" "Lanelet" "Road5" "Shape" "road2sim" "roadXML") ;
            sh:maxCount 1 ;
            sh:message "Validation of type failed!"@en ;
            sh:name "type"@en ;
            sh:order 0 ;
            sh:path hdmap:formatType ] .

hdmap:QualityShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass hdmap:Quality ;
    
    sh:property [ skos:example "0.1" ;
            sh:datatype xsd:float ;
            sh:description "Specifies the accuracy of traffic-relevant signals, signs and objects in metres."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of accuracySignals failed!"@en ;
            sh:minCount 0 ;
            sh:name "accuracy signals"@en ;
            sh:order 3 ;
            sh:path hdmap:accuracySignals ],
        [ skos:example "0.1" ;
            sh:datatype xsd:float ;
            sh:description "Specifies the accuracy, in metres, of objects within the traffic area that do not directly affect traffic."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of accuracyObjects failed!"@en ;
            sh:minCount 0 ;
            sh:name "accuracy objects"@en ;
            sh:order 4 ;
            sh:path hdmap:accuracyObjects ],
        [ skos:example "0.1" ;
            sh:datatype xsd:float ;
            sh:description "Specifies the accuracy of the lane model's height in metres."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of accuracyLaneModelHeight failed!"@en ;
            sh:minCount 0 ;
            sh:name "accuracy lane model height"@en ;
            sh:order 2 ;
            sh:path hdmap:accuracyLaneModelHeight ],
        [ skos:example "0.01" ;
            sh:datatype xsd:float ;
            sh:description "Specifies the relative precision of the measured road network in metres."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of precision failed!"@en ;
            sh:minCount 0 ;
            sh:name "precision"@en ;
            sh:order 0 ;
            sh:path hdmap:precision ],
        [ skos:example "0.1" ;
            sh:datatype xsd:float ;
            sh:description "Specifies the accuracy of the lane model in the 2D plane in metres."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of accuracyLaneModel2d failed!"@en ;
            sh:minCount 0 ;
            sh:name "accuracy lane model 2d"@en ;
            sh:order 1 ;
            sh:path hdmap:accuracyLaneModel2d ] .

hdmap:QuantityShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass hdmap:Quantity ;
    
    sh:property [ skos:example "5" ;
            sh:datatype xsd:unsignedInt ;
            sh:description "Specifies the total number of intersections defined in the HD map."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of numberIntersections failed!"@en ;
            sh:name "number intersections"@en ;
            sh:order 2 ;
            sh:path hdmap:numberIntersections ],
        [ skos:example "0" ;
            sh:datatype xsd:unsignedInt ;
            sh:description "Specifies the number of all traffic lights defined in the HD map."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of numberTrafficLights failed!"@en ;
            sh:name "number traffic lights"@en ;
            sh:order 3 ;
            sh:path hdmap:numberTrafficLights ],
        [ skos:example "20.3" ;
            sh:datatype xsd:float ;
            sh:description "Indicates the distance (in metres) to which the area beyond the traffic area has been modeled."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of rangeOfModeling failed!"@en ;
            sh:minCount 0 ;
            sh:name "range of modeling"@en ;
            sh:order 8 ;
            sh:path hdmap:rangeOfModeling ],
        [ skos:example "100" ;
            sh:datatype xsd:unsignedInt ;
            sh:description "Specifies the number of all outline objects defined in the HD map."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of numberOutlines failed!"@en ;
            sh:name "number outlines"@en ;
            sh:order 6 ;
            sh:path hdmap:numberOutlines ],
        [ skos:example "[10,50] km/h" ;
            sh:description "Specifies the range of speed limits defined in the HD map."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of speedLimit failed!"@en ;
            sh:name "speed limit"@en ;
            sh:node hdmap:Range2DShape ;
            sh:order 7 ;
            sh:path hdmap:speedLimit ],
        [ skos:example "40.0" ;
            sh:datatype xsd:float ;
            sh:description "Defines the total length (sum of road lengths) of the road network in kilometres."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of length failed!"@en ;
            sh:name "length"@en ;
            sh:order 0 ;
            sh:path hdmap:length ],
        [ skos:example "2.22" ;
            sh:datatype xsd:float ;
            sh:description "Specifies the difference between the maximum and minimum height of the road elevation profiles in metres."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of elevationRange failed!"@en ;
            sh:name "elevation range"@en ;
            sh:order 1 ;
            sh:path hdmap:elevationRange ],
        [ skos:example "200" ;
            sh:datatype xsd:unsignedInt ;
            sh:description "Specifies the number of all objects in the HD map."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of numberObjects failed!"@en ;
            sh:name "number objects"@en ;
            sh:order 5 ;
            sh:path hdmap:numberObjects ],
        [ skos:example "155" ;
            sh:datatype xsd:unsignedInt ;
            sh:description "Specifies the number of all traffic signs (signals) in the HD map."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of numberTrafficSigns failed!"@en ;
            sh:name "number traffic signs"@en ;
            sh:order 4 ;
            sh:path hdmap:numberTrafficSigns ] .

hdmap:Range2DShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass hdmap:Range2D ;
    
    sh:property [ 
            sh:datatype xsd:float ;
            sh:description "The maximum value of the range."@en ;
            sh:message "Validation of max failed! Max should be greater than min."@en ;
            sh:name "max"@en ;
            sh:order 1 ;
            sh:path hdmap:max 
        ],
        [ 
            sh:datatype xsd:float ;
            # [IMPROVEMENT] Added actual logic to enforce that Min <= Max
            sh:lessThanOrEquals hdmap:max ; 
            sh:description "The minimum value of the range."@en ;
            sh:message "Validation of min failed! Min should be less than or equal to max."@en ;
            sh:name "min"@en ;
            sh:order 0 ;
            sh:path hdmap:min 
        ] .
