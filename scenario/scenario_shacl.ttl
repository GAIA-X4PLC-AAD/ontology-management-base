@prefix scenario: <https://ontologies.envited-x.net/scenario/v5/ontology#> .
@prefix environment-model: <https://ontologies.envited-x.net/environment-model/v5/ontology#> .
@prefix hdmap: <https://ontologies.envited-x.net/hdmap/v5/ontology#> .
@prefix envited-x: <https://ontologies.envited-x.net/envited-x/v3/ontology#> .
@prefix manifest: <https://ontologies.envited-x.net/manifest/v5/ontology#> .
@prefix georeference: <https://ontologies.envited-x.net/georeference/v5/ontology#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .

### Scenario SHACL Shape
scenario:ScenarioShape a sh:NodeShape ;
    sh:closed false ;
    
    # 1) hasDataResource: 
    # Flexible: Allows either an INLINE DataResource (when fully defined) 
    # OR a Link (for draft/reference workflows where exposedThrough isn't known yet).
    sh:property [
        sh:path scenario:hasDataResource ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:or (
            [ sh:node envited-x:DataResourceShape ]
            [ sh:and ( manifest:LinkShape envited-x:ExtendedLinkShape ) ]
        ) ;
        sh:message "Each Scenario must have exactly one DataResource (Inline or Linked)."@en ;
    ] ;

    # 2) hasDataResourceExtension
    sh:property [
        sh:path scenario:hasDataResourceExtension ;
        sh:node scenario:DataResourceExtensionShape ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Each Scenario must have one associated DataResourceExtension object with format, content, quantity, quality, dataSource, and georeference."@en ;
    ] ;

    # 3) hasManifest
    sh:property [
        sh:path scenario:hasManifest ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:or (
            # Case 1: Inline manifest node
            [ sh:and (
                [ sh:node manifest:ManifestShape ]
                [ sh:node envited-x:ManifestShape ]
                [ sh:node scenario:ManifestShape ]
            )]
            
            # Case 2: Linked manifest reference
            [ sh:node envited-x:ManifestLinkReferenceShape ]
        ) ;
        sh:message "Each Scenario must have exactly one manifest. If linked, it must be a valid envited-x link specifically of category envited-x:isManifest."@en ;
    ] ;
    sh:targetClass scenario:Scenario .

scenario:ManifestShape a sh:NodeShape ;
    sh:closed false ;
    
    # The manifest node must be explicitly typed as scenario:Manifest.
    sh:property [
        sh:path rdf:type ;
        sh:hasValue scenario:Manifest ;
        sh:message "The manifest node must be explicitly typed as scenario:Manifest."@en ;
    ] ;
    
    # [FIXED] Aligned with envited-x and manifest ontologies (Direct Link)
    sh:property [
        sh:path manifest:hasLicense ;
        sh:node envited-x:LicenseLinkReferenceShape ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "A scenario manifest must contain exactly one license link conforming to envited-x:LicenseLinkReferenceShape (category envited-x:isLicense)."@en ;
    ] ;
    
    # Property shape for manifest reference:
    sh:property [
        sh:path manifest:hasManifestReference ;
        sh:qualifiedValueShape [
            sh:node envited-x:ManifestLinkReferenceShape ;
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:message "A scenario manifest must contain at least one manifest reference link with an envited-x access role and category."@en ;
    ] ;
    
    # Property shape for artifact links:
    sh:property [
        sh:path manifest:hasArtifacts ;
        sh:qualifiedValueShape [
            sh:node [ 
                sh:and ( manifest:LinkShape envited-x:ExtendedLinkShape )
            ] ;
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:message "A scenario manifest must contain at least one artifact link with an envited-x access role and category."@en ;
    ] ;

    # Property shape for external artifact links:
    sh:property [
        sh:path manifest:hasReferencedArtifacts ;
        sh:qualifiedValueShape [
            sh:node [ 
                sh:and ( manifest:LinkShape envited-x:ExtendedLinkShape )
            ] ;
        ] ;
        sh:qualifiedMinCount 0 ;
        sh:message "If provided, referenced artifact links must have an envited-x access role and category."@en ;
    ] ;

    # Ensure at least two manifest:Link(s) in hasArtifacts categorized as simulationData.
    sh:property [
        sh:path manifest:hasArtifacts ;
        sh:qualifiedValueShape [
            sh:and (
                [ sh:node manifest:LinkShape ]
                [ sh:node envited-x:ExtendedLinkShape ]
            ) ;
            sh:property [
                sh:path manifest:hasCategory ;
                sh:hasValue envited-x:isSimulationData ;
            ]
        ] ;
        sh:qualifiedMinCount 2 ; # NARROWING: Base requires 0 or 1, Scenario requires 2.
        sh:message "The scenario:Manifest must contain at least 2 manifest:Link(s) with category 'Simulation Data'."@en ;
    ] ;

    # Ensure at least two manifest:Link(s) in hasReferencedArtifacts categorized as referencedSimulationData.
    sh:property [
        sh:path manifest:hasReferencedArtifacts ;
        sh:qualifiedValueShape [
            sh:and (
                [ sh:node manifest:LinkShape ]
                [ sh:node envited-x:ExtendedLinkShape ]
            ) ;
            sh:property [
                sh:path manifest:hasCategory ;
                sh:hasValue envited-x:isReferencedSimulationData ;
            ]
        ] ;
        sh:qualifiedMinCount 2 ;
        sh:message "The scenario:Manifest must contain at least 2 manifest:Link(s) with category 'Referenced Simulation Data'."@en ;
    ] ;

    # Ensure at least one HD Map reference
    # [RECOMMENDED FIX] Tightened to ensure Link has correct Category
    sh:property [
        sh:path manifest:hasReferencedArtifacts ;
        sh:qualifiedValueShape [
            sh:or (
                [ sh:node hdmap:HdMap ]
                [ sh:and (
                    [ sh:node manifest:LinkShape ]
                    [ sh:node envited-x:ExtendedLinkShape ]
                    [ sh:property [ 
                        sh:path manifest:hasCategory ; 
                        sh:hasValue envited-x:isReferencedSimulationData 
                      ] 
                    ]
                ) ]
            )
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:name "HD Map reference"@en ;
        sh:description "Each scenario:Manifest must reference at least one HD Map."@en ;
    ] ;

    # Ensure at least one Environment Model reference
    # [RECOMMENDED FIX] Tightened to ensure Link has correct Category
    sh:property [
        sh:path manifest:hasReferencedArtifacts ;
        sh:qualifiedValueShape [
            sh:or (
                [ sh:node environment-model:EnvironmentModel ]
                [ sh:and (
                    [ sh:node manifest:LinkShape ]
                    [ sh:node envited-x:ExtendedLinkShape ]
                    [ sh:property [ 
                        sh:path manifest:hasCategory ; 
                        sh:hasValue envited-x:isReferencedSimulationData 
                      ] 
                    ]
                ) ]
            )
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:name "Environment Model reference"@en ;
        sh:description "Each scenario:Manifest must reference at least one Environment Model."@en ;
    ] ;

    # Ensure at least one catalog reference
    # [RECOMMENDED FIX] Tightened to ensure Link has correct Category
    sh:property [
        sh:path manifest:hasArtifacts ;
        sh:qualifiedValueShape [
            sh:and (
                [ sh:node manifest:LinkShape ]
                [ sh:node envited-x:ExtendedLinkShape ]
                [ sh:property [ 
                    sh:path manifest:hasCategory ; 
                    sh:hasValue envited-x:isSimulationData 
                  ] 
                ]
            )
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:name "catalog reference"@en ;
        sh:description "Each scenario:Manifest must reference at least one catalog via a manifest:Link."@en ;
    ] ;

    sh:targetClass scenario:Manifest .


### DataResourceExtension SHACL Shape
scenario:DataResourceExtensionShape a sh:NodeShape ;
    sh:closed false ;
    
    sh:property 
        [ sh:maxCount 1 ;
          sh:minCount 1 ;
          sh:node scenario:ContentShape ;
          sh:path scenario:hasContent ],
        [ sh:maxCount 1 ;
          sh:minCount 1 ;
          sh:node scenario:FormatShape ;
          sh:path scenario:hasFormat ],
        [ sh:maxCount 1 ;
          sh:minCount 1 ;
          sh:node scenario:QualityShape ;
          sh:path scenario:hasQuality ],
        [ sh:maxCount 1 ;
          sh:minCount 1 ;
          sh:node scenario:QuantityShape ;
          sh:path scenario:hasQuantity ],
        [ sh:maxCount 1 ;
          sh:minCount 1 ;
          sh:node scenario:DataSourceShape ;
          sh:path scenario:hasDataSource ],
        [ sh:maxCount 1 ;
          sh:minCount 1 ;
          sh:node georeference:GeoreferenceShape ;
          sh:path scenario:hasGeoreference ] ;
    sh:targetClass scenario:DataResourceExtension .

# Minimal shapes for connected nodes
scenario:FormatShape a sh:NodeShape ; sh:closed false ; sh:targetClass scenario:Format .
scenario:ContentShape a sh:NodeShape ; sh:closed false ; sh:targetClass scenario:Content .
scenario:QuantityShape a sh:NodeShape ; sh:closed false ; sh:targetClass scenario:Quantity .
scenario:QualityShape a sh:NodeShape ; sh:closed false ; sh:targetClass scenario:Quality .
scenario:DataSourceShape a sh:NodeShape ; sh:closed false ; sh:targetClass scenario:DataSource .
