@prefix scenario: <https://ontologies.envited-x.net/scenario/v5/ontology#> .
@prefix environment-model: <https://ontologies.envited-x.net/environment-model/v5/ontology#> .
@prefix hdmap: <https://ontologies.envited-x.net/hdmap/v5/ontology#> .
@prefix envited-x: <https://ontologies.envited-x.net/envited-x/v3/ontology#> .
@prefix manifest: <https://ontologies.envited-x.net/manifest/v5/ontology#> .
@prefix georeference: <https://ontologies.envited-x.net/georeference/v5/ontology#> .
@prefix openlabel: <https://openlabel.asam.net/V1-0-0/ontologies/> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .

### Scenario SHACL Shape
scenario:ScenarioShape a sh:NodeShape ;
    sh:closed false ;

    # 1) hasDataResource
    sh:property [
        sh:path scenario:hasDataResource ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:or (
            [ sh:node envited-x:DataResourceShape ]
            [ sh:and ( manifest:LinkShape envited-x:ExtendedLinkShape ) ]
        ) ;
        sh:message "Each Scenario must have exactly one DataResource (Inline or Linked)."@en ;
    ] ;

    # 2) hasDataResourceExtension
    sh:property [
        sh:path scenario:hasDataResourceExtension ;
        sh:node scenario:DataResourceExtensionShape ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Each Scenario must have one associated DataResourceExtension."@en ;
    ] ;

    # 3) hasManifest
    sh:property [
        sh:path scenario:hasManifest ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:or (
            # Case 1: Linked manifest reference
            [ sh:node envited-x:ManifestLinkReferenceShape ]

            # Case 2: Inline manifest node
            [ sh:and (
                [ sh:node manifest:ManifestShape ]
                [ sh:node envited-x:ManifestShape ]
                [ sh:node scenario:ScenarioManifestConstraints ] 
            )]
        ) ;
        sh:message "Each Scenario must have exactly one manifest (Inline or Linked)."@en ;
    ] ;
    sh:targetClass scenario:Scenario .


### Scenario Specific Manifest Constraints
scenario:ScenarioManifestConstraints a sh:NodeShape ;
    
    # "A scenario MAY have an hdmap and environment model"
    sh:property [
        sh:path manifest:hasReferencedArtifacts ;
        
        # Validates EVERY item in the list against these options
        sh:node [
            a sh:NodeShape ;
            sh:or (
                # Option A: Full inline HD Map (Points to the SHAPE, not the Class)
                [ sh:node hdmap:HdMapShape ] 
                
                # Option B: Full inline Environment Model (Points to the SHAPE)
                [ sh:node environment-model:EnvironmentModelShape ]

                # Option C: Valid Link with category 'Simulation Data'
                [ sh:and (
                    [ sh:node manifest:LinkShape ]
                    [ sh:node envited-x:ExtendedLinkShape ]
                    [ sh:property [ 
                        sh:path manifest:hasCategory ; 
                        sh:hasValue envited-x:isSimulationData ;
                        sh:message "Referenced Artifacts in a Scenario MUST be of category 'Simulation Data' (since they are already distinguished by being in the 'referencedArtifacts' list)." 
                      ] 
                    ]
                )]
            )
        ] ;
        sh:message "Any referenced artifact provided must be either an HD Map, an Environment Model, or a valid link with category 'Simulation Data'."@en ;
    ] .


### DataResourceExtension SHACL Shape
scenario:DataResourceExtensionShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass scenario:DataResourceExtension ;
    
    sh:property 
        # hasContent: Modified to use ContentOrTagShape and allow multiple items (no maxCount 1)
        [ 
            sh:path scenario:hasContent ;
            sh:minCount 1 ;
            sh:node scenario:ContentOrTagShape ;
            sh:name "content object"@en ;
            sh:description "Attributes describing the content of the scenario."@en ;
        ],
        [ sh:maxCount 1 ; sh:minCount 1 ; sh:node scenario:FormatShape ; sh:path scenario:hasFormat ],
        [ sh:maxCount 1 ; sh:minCount 1 ; sh:node scenario:QualityShape ; sh:path scenario:hasQuality ],
        [ sh:maxCount 1 ; sh:minCount 1 ; sh:node scenario:QuantityShape ; sh:path scenario:hasQuantity ],
        [ sh:maxCount 1 ; sh:minCount 1 ; sh:node scenario:DataSourceShape ; sh:path scenario:hasDataSource ],
        [ sh:maxCount 1 ; sh:minCount 1 ; sh:node georeference:GeoreferenceShape ; sh:path scenario:hasGeoreference ] .

### New Union Shape for Content
scenario:ContentOrTagShape a sh:NodeShape ;
    sh:description "Scenario Content or OpenLABEL Tag Union Shape"@en ;
    sh:or (
        [ sh:node scenario:ContentShape ]
        [ sh:node openlabel:TagShape ]
        [ sh:node xsd:boolean ]
    ) ;
    sh:message "Each item of hasContent must conform to either Scenario Content, an OpenLABEL Tag, or a boolean."@en .

### Detailed Shapes (Expanded based on Instance Data)

scenario:FormatShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass scenario:Format ;
    sh:property [
        sh:path scenario:formatType ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:message "Format type is required (e.g. 'ASAM OpenSCENARIO')."@en ;
    ],
    [
        sh:path scenario:version ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:message "Format version is required."@en ;
    ] .

scenario:ContentShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass scenario:Content ;
    
    # Restored full properties from HEAD version to ensure no information omission
    sh:property [ skos:example "Functional, Logical, Concrete" ;
            sh:description "Specifies the abstraction level (as defined in the Pegasus project) of the scenario asset."@en ;
            sh:in ("Functional" "Logical" "Concrete") ;
            sh:maxCount 1 ;
            sh:message "Validation of type failed!"@en ;
            sh:name "abstraction level"@en ;
            sh:order 1 ;
            sh:path scenario:abstractionLevel ],
        [ skos:example "2009-06-30T18:30:00+02:00" ;
            sh:datatype xsd:dateTime ;
            sh:description "Optionally specifies the time associated with the scenario asset (e.g., time of recording or time of event for a synthetic scenario)."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of timeDate failed!"@en ;
            sh:minCount 0 ;
            sh:name "time date"@en ;
            sh:order 2 ;
            sh:path scenario:timeDate ],
        [ skos:example "criticality analysis, testing, specific component tests (e.g. lateral movement control)"@en ;
            sh:datatype xsd:string ;
            sh:description "Defines the purpose of the scenario asset."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of aim failed!"@en ;
            sh:minCount 0 ;
            sh:name "aim"@en ;
            sh:order 3 ;
            sh:path scenario:aim ],
        [ skos:example "GlobalPosition" ;
            skos:example "ParameterDeclaration" ;
            sh:datatype xsd:string ;
            sh:description "Specifies which functions (e.g., actions) from the standard are utilized."@en ;
            sh:message "Validation of usedStandardFunctions failed!"@en ;
            sh:maxCount 1 ;
            sh:minCount 0 ;
            sh:name "used functions in the standard"@en ;
            sh:order 4 ;
            sh:path scenario:usedStandardFunctions ],
        [ skos:example "via trajectory, via support points"@en ;
            sh:datatype xsd:string ;
            sh:description "Indicates the type of movement employed by traffic participants according to the ASAM OpenSCENARIO standard."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of movementDescription failed!"@en ;
            sh:name "movement description"@en ;
            sh:order 5 ;
            sh:path scenario:movementDescription ],
        [ skos:example "stopIfTTCLowerThan" ;
            sh:datatype xsd:string ;
            sh:description "Defines scenario- or domain-specific commands or actions used in the scenario asset."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of customCommands failed!"@en ;
            sh:minCount 0 ;
            sh:name "custom commands"@en ;
            sh:order 6 ;
            sh:path scenario:customCommands ],
        [ skos:example "194.01" ;
            sh:datatype xsd:float ;
            sh:description "Defines the azimuth of the sun in degrees."@en ;
            sh:message "Validation of sunAzimuth failed!"@en ;
            sh:minCount 0 ;
            sh:name "sun azimuth"@en ;
            sh:order 10 ;
            sh:minInclusive -360 ;
            sh:maxInclusive 360 ;
            sh:path scenario:sunAzimuth ],
        [ skos:example "kangaroo crossing" ;
            sh:datatype xsd:string ;
            sh:description "Indicates which country-specific traffic signs are used in the scenario asset."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of countrySpecificSign failed!"@en ;
            sh:minCount 0 ;
            sh:name "country specific sign"@en ;
            sh:order 11 ;
            sh:path scenario:countrySpecificSign ],
        [ skos:example "tuk tuk" ;
            sh:datatype xsd:string ;
            sh:description "Indicates which country-specific participants are used in the scenario asset."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of countrySpecificTrafficParticipants failed!"@en ;
            sh:minCount 0 ;
            sh:name "country specific traffic participants"@en ;
            sh:order 12 ;
            sh:path scenario:countrySpecificTrafficParticipants ],
        [ skos:example "germany, not applicable" ;
            sh:datatype xsd:string ;
            sh:description "Indicates the country of origin for the scenario asset."@en ;
            sh:maxCount 1 ;
            sh:message "Validation of country failed!"@en ;
            sh:minCount 0 ;
            sh:name "country"@en ;
            sh:order 13 ;
            sh:path scenario:country ] .

scenario:QuantityShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass scenario:Quantity ;
    sh:property [
        sh:path scenario:numberTrafficObjects ;
        sh:datatype xsd:unsignedInt ;
        sh:message "Number of traffic objects must be an unsigned integer."@en ;
    ],
    [
        sh:path scenario:permanentTrafficObjects ;
        sh:datatype xsd:unsignedInt ;
    ],
    [
        sh:path scenario:temporaryTrafficObjects ;
        sh:datatype xsd:unsignedInt ;
    ],
    [
        sh:path scenario:controllers ;
        sh:datatype xsd:string ;
    ] .

scenario:QualityShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass scenario:Quality ;
    sh:property [
        sh:path scenario:accuracyObjects ;
        sh:datatype xsd:float ;
    ],
    [
        sh:path scenario:calibration ;
        sh:datatype xsd:string ;
    ] .

scenario:DataSourceShape a sh:NodeShape ;
    sh:closed false ;
    sh:targetClass scenario:DataSource ;
    sh:property [
        sh:path scenario:sourceType ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
    ],
    [
        sh:path scenario:sourceDescription ;
        sh:datatype xsd:string ;
    ] .
