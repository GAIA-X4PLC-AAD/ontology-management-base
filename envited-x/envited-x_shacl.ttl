@prefix envited-x: <https://ontologies.envited-x.net/envited-x/v3/ontology#> .
@prefix manifest: <https://ontologies.envited-x.net/manifest/v5/ontology#> .
@prefix gx: <https://registry.lab.gaia-x.eu/development/api/trusted-shape-registry/v1/shapes/jsonld/trustframework#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .


# envited-x SHACL shape
envited-x:SimulationAssetShape a sh:NodeShape ;
    sh:closed false ;
    

    #################################################################
    # hasDataResource:
    #  - At least one inline envited-x:DataResource is REQUIRED.
    #  - Additional values MAY be manifest:Link + envited-x:ExtendedLinkShape.
    #################################################################

    # 1) Guard: every hasDataResource value must be either
    #    - an inline DataResource (envited-x:DataResourceShape), OR
    #    - a link (manifest:LinkShape + envited-x:ExtendedLinkShape).
    sh:property [
        sh:path envited-x:hasDataResource ;
        sh:minCount 1 ;
        sh:or (
            [ sh:node envited-x:DataResourceShape ]
            [ sh:and ( manifest:LinkShape envited-x:ExtendedLinkShape ) ]
        ) ;
        sh:message "Each value of envited-x:hasDataResource MUST be either (a) an inline envited-x:DataResource conforming to envited-x:DataResourceShape, or (b) a manifest:Link that conforms to envited-x:ExtendedLinkShape (for external or later-extended Gaia-X metadata)."@en ;
    ] ;

    # 2) Cardinality: there must be AT LEAST ONE inline DataResource.
    #    (Links are optional extras.)
    sh:property [
        sh:path envited-x:hasDataResource ;
        sh:qualifiedValueShape [
            sh:node envited-x:DataResourceShape
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:message "Each SimulationAsset must have at least one INLINE envited-x:DataResource (conforming to envited-x:DataResourceShape) that provides gx:name and gx:description."@en ;
    ] ;

    #################################################################
    # hasDataResourceExtension: optional, but if present must conform
    # to envited-x:DataResourceExtensionShape (hasContent + hasFormat).
    #################################################################
    sh:property [
        sh:path envited-x:hasDataResourceExtension ;
        sh:node envited-x:DataResourceExtensionShape ;
        sh:minCount 0 ;  # Optional
        sh:message "A SimulationAsset may have one or more DataResourceExtensions (e.g. georeference metadata, sensor calibration) to provide additional structured metadata. Each extension MUST conform to envited-x:DataResourceExtensionShape (at least one envited-x:hasContent and one envited-x:hasFormat)."@en ;
    ] ;

    #################################################################
    # hasManifest: exactly one, inline OR link.
    #################################################################
    # envited-x:SimulationAssetShape improvements
    sh:property [
        sh:path envited-x:hasManifest ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:or (
            # Case 1: Inline manifest node
            [ sh:and ( manifest:ManifestShape envited-x:ManifestShape ) ]
            
            # Case 2: Linked manifest reference
            [ sh:node envited-x:ManifestLinkReferenceShape ]
        ) ;
        sh:message "Each SimulationAsset must have exactly one manifest. If linked, it MUST be of category envited-x:isManifest and include a manifest:iri."@en ;
    ] ;

    sh:targetClass envited-x:SimulationAsset .


envited-x:ExtendedLinkShape a sh:NodeShape ;
  sh:property [
    sh:path manifest:hasAccessRole ;
    sh:in ( envited-x:isPublic envited-x:isOwner envited-x:isRegistered ) ;
    sh:message "Access role must be one of the envited-x defined access roles." ;
  ] ;
  sh:property [
    sh:path manifest:hasCategory ;
    sh:in (
      envited-x:isManifest
      envited-x:isLicense
      envited-x:isMiscellaneous
      envited-x:isSimulationData
      envited-x:isReferencedSimulationData
      envited-x:isDocumentation
      envited-x:isMedia
      envited-x:isMetadata
      envited-x:isValidationReport
    ) ;
    sh:message "Category must be one of the envited-x defined categories." ;
  ] .


#################################################################
# Shape for manifest:Link
# (specialization of manifest:Link that points to manifests)
#################################################################
envited-x:ManifestLinkReferenceShape a sh:NodeShape ;
    sh:node manifest:LinkShape ;           # Ensures base link metadata (filePath, mimeType)
    sh:node envited-x:ExtendedLinkShape ;    # Ensures envited-x specific roles/categories
    
    # Specific Narrowing for Manifests:
    sh:property [
        sh:path manifest:hasCategory ;
        sh:hasValue envited-x:isManifest ;   # Forces the category to be specifically isManifest
        sh:message "A link used in hasManifest must have the category envited-x:isManifest."@en ;
    ] ;
    sh:property [
        sh:path manifest:iri ;
        sh:minCount 1 ;
        sh:message "A linked manifest reference must specify a manifest:iri (e.g., a DID)."@en ;
    ] .


# Manifest Shape for additional constraints
envited-x:ManifestShape a sh:NodeShape ;
    sh:closed false ;
    sh:property [
        sh:path rdf:type ;
        sh:hasValue envited-x:Manifest ;
        sh:message "The manifest node must be explicitly typed as envited-x:Manifest."@en ;
    ] ;
    # Property shape for artifact links:
    sh:property [
        sh:path manifest:hasManifestReference ;
        sh:qualifiedValueShape [
            sh:and ( manifest:LinkShape envited-x:ExtendedLinkShape )
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:qualifiedMaxCount 1 ;
        sh:message "An envited-x manifest must contain exactly one manifest reference link with an envited-x access role and category."@en ;
    ] ;
    sh:property [
        sh:path manifest:hasLicense ;
        sh:qualifiedValueShape [
            sh:node manifest:LicenseShape ;
            sh:property [
                sh:path manifest:hasLink ;
                sh:qualifiedValueShape [
                    sh:and ( manifest:LinkShape envited-x:ExtendedLinkShape )
                ] ;
                sh:qualifiedMinCount 1 ;
                sh:qualifiedMaxCount 1 ;
                sh:message "A license must contain exactly one link with an envited-x access role and category."@en ;
            ]
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:qualifiedMaxCount 1 ;
        sh:message "An envited-x manifest must contain exactly one license link with an envited-x access role and category."@en ;
    ] ;
    
    # Property shape for artifact links:
    sh:property [
        sh:path manifest:hasArtifacts ;
        sh:qualifiedValueShape [
            sh:and ( manifest:LinkShape envited-x:ExtendedLinkShape )
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:message "An envited-x manifest must contain at least one artifact link with an envited-x access role and category."@en ;
    ] ;
    # Property shape for external artifact links:
    sh:property [
        sh:path manifest:hasReferencedArtifacts ;
        sh:qualifiedValueShape [
            sh:and ( manifest:LinkShape envited-x:ExtendedLinkShape )
        ] ;
        sh:qualifiedMinCount 0 ;
        sh:message "If provided, referenced artifact links must have an envited-x access role and category."@en ;
    ] ;
    # Ensure at least one `manifest:Link` for each required category
    sh:property [
        sh:path manifest:hasArtifacts ;
        sh:qualifiedValueShape [
            sh:node manifest:LinkShape ;
            sh:property [
                sh:path manifest:hasCategory ;
                sh:hasValue envited-x:isSimulationData ;
            ]
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:message "The envited-x:Manifest must contain at least 1 manifest:Link with category 'Simulation Data'."@en ;
    ] ;

    sh:property [
        sh:path manifest:hasArtifacts ;
        sh:qualifiedValueShape [
            sh:node manifest:LinkShape ;
            sh:property [
                sh:path manifest:hasCategory ;
                sh:hasValue envited-x:isDocumentation ;
            ]
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:message "The envited-x:Manifest must contain at least 1 manifest:Link with category 'Documentation'."@en ;
    ] ;

    sh:property [
        sh:path manifest:hasArtifacts ;
        sh:qualifiedValueShape [
            sh:node manifest:LinkShape ;
            sh:property [
                sh:path manifest:hasCategory ;
                sh:hasValue envited-x:isMetadata ;
            ]
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:message "The envited-x:Manifest must contain at least 1 manifest:Link with category 'Metadata'."@en ;
    ] ;

    sh:property [
        sh:path manifest:hasArtifacts ;
        sh:qualifiedValueShape [
            sh:node manifest:LinkShape ;
            sh:property [
                sh:path manifest:hasCategory ;
                sh:hasValue envited-x:isMedia ;
            ]
        ] ;
        sh:qualifiedMinCount 1 ;
        sh:message "The envited-x:Manifest must contain at least 1 manifest:Link with category 'Media'."@en ;
    ] ;

    sh:targetClass envited-x:Manifest .


# SHACL Shape for envited-x:DataResource
envited-x:DataResourceShape a sh:NodeShape ;
    sh:closed false ;
    
    sh:property [ 
        sh:path gx:name ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Each SimulationAsset must have a human-readable name of the entity."@en ;
        skos:example "3D Model of Grafing"@en ;
        sh:order 0 
    ] ;
    sh:property [ 
        sh:path gx:description ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Each SimulationAsset must have a textual description of the entity."@en ;
        skos:example "Town district with traffic signs."@en ;
        sh:order 1 
    ] ;
    sh:targetClass envited-x:DataResource .


# SHACL Shape for envited-x:DataResourceExtension
envited-x:DataResourceExtensionShape a sh:NodeShape ;
    sh:closed false ;
    

    # If an extension exists, it must have content...
    sh:property [
        sh:path envited-x:hasContent ;
        sh:minCount 1 ;
        sh:message "Each DataResourceExtension must link to at least one envited-x:Content via envited-x:hasContent."@en ;
    ] ;

    # ...and format
    sh:property [
        sh:path envited-x:hasFormat ;
        sh:minCount 1 ;
        sh:message "Each DataResourceExtension must link to at least one envited-x:Format via envited-x:hasFormat."@en ;
    ] ;

    # Optional extras (minCount 0 is the default, you can omit these completely
    # unless you want a custom message)
    sh:property [
        sh:path envited-x:hasDataSource ;
        sh:minCount 0 ;
        sh:message "Optional: a DataResourceExtension may specify how the asset was created via envited-x:hasDataSource."@en ;
    ] ;
    sh:property [
        sh:path envited-x:hasQuality ;
        sh:minCount 0 ;
        sh:message "Optional: a DataResourceExtension may specify quality information via envited-x:hasQuality."@en ;
    ] ;
    sh:property [
        sh:path envited-x:hasQuantity ;
        sh:minCount 0 ;
        sh:message "Optional: a DataResourceExtension may specify quantity-related information via envited-x:hasQuantity."@en ;
    ] ;

    sh:targetClass envited-x:DataResourceExtension .


# Minimal SHACL shape for envited-x:Content
envited-x:ContentShape a sh:NodeShape ;
    sh:closed false ;
    
    sh:message "Node must be of type envited-x:Content." ;
    sh:targetClass envited-x:Content .


# Minimal SHACL shape for envited-x:DataSource
envited-x:DataSourceShape a sh:NodeShape ;
    sh:closed false ;
    
    sh:message "Node must be of type envited-x:DataSource." ;
    sh:targetClass envited-x:DataSource .


# Minimal SHACL shape for envited-x:Format
envited-x:FormatShape a sh:NodeShape ;
    sh:closed false ;
    
    sh:message "Node must be of type envited-x:Format." ;
    sh:targetClass envited-x:Format .


# Minimal SHACL shape for envited-x:Quality
envited-x:QualityShape a sh:NodeShape ;
    sh:closed false ;
    
    sh:message "Node must be of type envited-x:Quality." ;
    sh:targetClass envited-x:Quality .


# Minimal SHACL shape for envited-x:Quantity
envited-x:QuantityShape a sh:NodeShape ;
    sh:closed false ;
    
    sh:message "Node must be of type envited-x:Quantity." ;
    sh:targetClass envited-x:Quantity .
